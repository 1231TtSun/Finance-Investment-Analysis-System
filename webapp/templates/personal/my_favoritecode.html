{% extends "stock_base.html" %}
{% block current_user %}
    当前用户：{{ current_user.username }}
{% endblock %}

{% block body %}
    {#    this is the body part#}
    <div class="span9">
        <div class="content">
            <div class="btn-controls">
                {#    This is the modal for addStock#}
                <div class="modal fade" id="addStock" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <h4 class="modal-title" id="myModalLabel">添加关注</h4>
                            </div>
                            <form id="searchform" class="navbar-form navbar-left" role="search" method="post"
                                  action="{{ url_for('restfulapi.add_code') }}">
                                <div class="modal-body">
                                    <div calss="input-group">
                                        <div class="form-group form-inline">
                                            <label>股票： </label>
                                            <input type="text" id="stockcode" name="stockcode" placeholder="Search"
                                                   class="form-control"
                                                   title="代码/拼音/名称"
                                                   style="color: rgb(153, 153, 153);">
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" onclick="addStock()">确认</button>
                                </div>
                            </form>

                        </div><!-- /.modal-content -->
                    </div><!-- /.modal-dialog -->
                </div>

                {#                股票列表#}
                <div class="module">
                    <div class="module-head">
                        <button id="head1" class="btn btn-primary" data-toggle="button">关注列表</button>
                        <div class="span3 pull-right" style="float:rihght;margin-right:px">
                            <button class="btn btn-mini btn-primary" type="button" data-toggle="modal"
                                    data-target="#addStock">添加
                            </button>
                            <button class="btn btn-mini btn-danger" type="button" id="deleteStock"
                            >删除
                            </button>

                        </div>
                    </div>
                    <div class="module-body" id="body1">
                        <div class="btn-box-row row-fluid">
                            <div class="span12" style="background-color:white">
                                <div style="height:100px;">
                                    <table id="mytable1" style="text-align:center;height:100px">
                                        <thead>
                                        <tr>
                                            <th>
                                                选择
                                            </th>
                                            <th>
                                                编号
                                            </th>
                                            <th>
                                                名称
                                            </th>
                                            <th>
                                                最新价格
                                            </th>
                                            <th>
                                                涨跌幅
                                            </th>
                                            <th>
                                                关注人数
                                            </th>
                                        </tr>
                                        </thead>
                                        <tbody id="tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="btn-box-row row-fluid">
                    <div class="module span12" style="background-color: transparent">
                        <div class="module-head">
                            <button id="head2" class="btn btn-primary" data-toggle="button">行业状况</button>
                        </div>
                        <div class="row-fluid" id="body2">
                            <div class="btn-box small span3">
                                <div id="windpie_1" style="width:100%;height:200px;background-color: white"></div>
                            </div>
                            <div class="btn-box small span3">
                                <div id="windpie_2" style="width:100%;height:200px;background-color: white"></div>
                            </div>
                            <div class="btn-box small span3">
                                <div id="windpie_3" style="width:100%;height:200px;background-color: white"></div>
                            </div>
                            <div class="btn-box small span3">
                                <div id="windpie_4" style="width:100%;height:200px;background-color: white"></div>
                            </div>

                        </div>
                    </div>
                </div>

                {#                基础指标&&投资指标#}
                <div class="btn-box-row row-fluid">
                    <div class="module span12" style="background-color: transparent">
                        <div class="module-head">
                            <button id="head3" class="btn btn-primary" data-toggle="button">指标概况</button>
                            <input
                                    type="text" id="year_pie"
                                    style="background-color:white;width: 70px;margin-top: 5px;height:20px"/>
                        </div>
                        <div class="row-fluid" id="body3">
                            <div class="span6" style="background-color:white">
                                {#                        style="width:300px;height:250px;background-color:white;border-radius:5px;float:left"#}
                                <div id="index_chart_by_year" style="height:200px;margin:0 auto;">

                                </div>
                                <div style="height:40px;margin:0 auto;width:300px">

                                    <a style="width:50px;margin-left:10px;color: #0c0c0c">指标:</a>
                                    <select id="index_select_pie" style="width:100px">

                                    </select>
                                </div>
                            </div>
                            <div class="span6" style="background-color:white">
                                <div id="index_chart_by_year_2" style="height:200px;margin:0 auto;">

                                </div>
                                <div style="height:40px;margin:0 auto;width:300px">
                                    <a style="width:50px;margin-left:10px;color: #0c0c0c">指标:</a>
                                    <select id="index_select_pie_2" style="width:100px">

                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!--/#btn-controls-->
            {#股票对比#}
            <div class="module" style="margin-top:10px;border-radius:5px">
                <div id="div_gpdb" class="fb">
                    <div class="module-head">
                        <button id="head4" class="btn btn-primary" data-toggle="button">股票对比</button>
                        <a style="width:50px;margin-left:10px;color: #0c0c0c">起:</a><input
                            type="text" id="ui3"
                            style="width: 70px;margin-left: 10px"/>
                        <a style="width:50px;margin-left:10px;color: #0c0c0c">止:</a>
                        <input type="text" id="ui4"
                               style="width: 70px;margin-left: 10px"/>
                        {#                                    <a style="width:50px;margin-left:10px;color: #0c0c0c">单位:</a>#}
                        <select id="unit" style="width:50px;margin-left:10px">
                            <option value="100000000">亿</option>
                            <option value="1000000000">十亿</option>
                            <option value="10000000">千万</option>
                            <option value="1">元</option>
                        </select>
                        {#                                    <a style="width:50px;margin-left:10px;color: #0c0c0c">年份排序:</a>#}
                        <select id="yearorder" style="width:70px;margin-left:10px">
                            <option value="asc">升序</option>
                            <option value="desc">降序</option>
                        </select>
                        {#                                    <a style="width:50px;margin-left:10px;color: #0c0c0c">指标选择:</a>#}
                        <select id="index_select" style="width:100px;margin-left:10px">
                        </select>
                    </div>
                    <div class="module-body" id="body4">
                        <div calss="span12">
                            <div id="placeholder2" class="graph" style="height: 300px">
                                <div class="leftbox" style="position:relative;">
                                    <div>
                                        {#                                            <legend style="font-size:9px">比较代码列表</legend>#}
                                        <div id="code_checkbox"
                                             style="height:80%;overflow-y :auto;margin-top:4.5%">
                                            <div id="div_compare" style="overflow-y: auto;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="rightbox">
                                    <ul id="myTab" class="nav nav-tabs">
                                        <li class="disabled">
                                            <a href="javascript:return false;" data-toggle="tab"
                                               disabled='true'>视图：</a>
                                        </li>
                                        <li><a href="#chart" data-toggle="tab">图表</a></li>
                                        <li><a href="#table" data-toggle="tab" onclick="RequestTable()">数据</a>
                                        </li>
                                    </ul>
                                    <div id="myTabContent" class="tab-content" style="width: 100%">
                                        <div class="tab-pane fade in active" id="chart">
                                            <div id="echart1"
                                                 style="width: auto;height:80%;margin-left:20px;margin-top: 10px;">

                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="table" style="width:  100%">
                                            <div id="mytable"
                                                 style="width: 100%;height:80%;overflow-y:scroll;overflow-x:scroll;">
                                                <table id="fixTable" class="row-border hover order-column"
                                                       cellspacing="0" width="100%">
                                                    <thead id="table_head">

                                                    </thead>
                                                    <tbody id="table_body">

                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>


                                </div>

                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--/.content-->
    </div>

    <script>
        $("#head1").click(function () {
            $("#body1").toggle()
        })
        $("#head4").click(function () {
            $("#body4").toggle()
        })
        $("#head2").click(function () {
            $("#body2").toggle()
        })
        $("#head3").click(function () {
            $("#body3").toggle()
        })

    </script>
    <script>
        {#        bo#}
        {#map coordinates#}
        var geoCoordMap = {
            '海门': [121.15, 31.89],
            '鄂尔多斯': [109.781327, 39.608266],
            '招远': [120.38, 37.35],
            '舟山': [122.207216, 29.985295],
            '齐齐哈尔': [123.97, 47.33],
            '盐城': [120.13, 33.38],
            '赤峰': [118.87, 42.28],
            '青岛': [120.33, 36.07],
            '乳山': [121.52, 36.89],
            '金昌': [102.188043, 38.520089],
            '泉州': [118.58, 24.93],
            '莱西': [120.53, 36.86],
            '日照': [119.46, 35.42],
            '胶南': [119.97, 35.88],
            '南通': [121.05, 32.08],
            '拉萨': [91.11, 29.97],
            '云浮': [112.02, 22.93],
            '梅州': [116.1, 24.55],
            '文登': [122.05, 37.2],
            '上海': [121.48, 31.22],
            '攀枝花': [101.718637, 26.582347],
            '威海': [122.1, 37.5],
            '承德': [117.93, 40.97],
            '厦门': [118.1, 24.46],
            '汕尾': [115.375279, 22.786211],
            '潮州': [116.63, 23.68],
            '丹东': [124.37, 40.13],
            '太仓': [121.1, 31.45],
            '曲靖': [103.79, 25.51],
            '烟台': [121.39, 37.52],
            '福州': [119.3, 26.08],
            '瓦房店': [121.979603, 39.627114],
            '即墨': [120.45, 36.38],
            '抚顺': [123.97, 41.97],
            '玉溪': [102.52, 24.35],
            '张家口': [114.87, 40.82],
            '阳泉': [113.57, 37.85],
            '莱州': [119.942327, 37.177017],
            '湖州': [120.1, 30.86],
            '汕头': [116.69, 23.39],
            '昆山': [120.95, 31.39],
            '宁波': [121.56, 29.86],
            '湛江': [110.359377, 21.270708],
            '揭阳': [116.35, 23.55],
            '荣成': [122.41, 37.16],
            '连云港': [119.16, 34.59],
            '葫芦岛': [120.836932, 40.711052],
            '常熟': [120.74, 31.64],
            '东莞': [113.75, 23.04],
            '河源': [114.68, 23.73],
            '淮安': [119.15, 33.5],
            '泰州': [119.9, 32.49],
            '南宁': [108.33, 22.84],
            '营口': [122.18, 40.65],
            '惠州': [114.4, 23.09],
            '江阴': [120.26, 31.91],
            '蓬莱': [120.75, 37.8],
            '韶关': [113.62, 24.84],
            '嘉峪关': [98.289152, 39.77313],
            '广州': [113.23, 23.16],
            '延安': [109.47, 36.6],
            '太原': [112.53, 37.87],
            '清远': [113.01, 23.7],
            '中山': [113.38, 22.52],
            '昆明': [102.73, 25.04],
            '寿光': [118.73, 36.86],
            '盘锦': [122.070714, 41.119997],
            '长治': [113.08, 36.18],
            '深圳': [114.07, 22.62],
            '珠海': [113.52, 22.3],
            '宿迁': [118.3, 33.96],
            '咸阳': [108.72, 34.36],
            '铜川': [109.11, 35.09],
            '平度': [119.97, 36.77],
            '佛山': [113.11, 23.05],
            '海口': [110.35, 20.02],
            '江门': [113.06, 22.61],
            '章丘': [117.53, 36.72],
            '肇庆': [112.44, 23.05],
            '大连': [121.62, 38.92],
            '临汾': [111.5, 36.08],
            '吴江': [120.63, 31.16],
            '石嘴山': [106.39, 39.04],
            '沈阳': [123.38, 41.8],
            '苏州': [120.62, 31.32],
            '茂名': [110.88, 21.68],
            '嘉兴': [120.76, 30.77],
            '长春': [125.35, 43.88],
            '胶州': [120.03336, 36.264622],
            '银川': [106.27, 38.47],
            '张家港': [120.555821, 31.875428],
            '三门峡': [111.19, 34.76],
            '锦州': [121.15, 41.13],
            '南昌': [115.89, 28.68],
            '柳州': [109.4, 24.33],
            '三亚': [109.511909, 18.252847],
            '自贡': [104.778442, 29.33903],
            '吉林': [126.57, 43.87],
            '阳江': [111.95, 21.85],
            '泸州': [105.39, 28.91],
            '西宁': [101.74, 36.56],
            '宜宾': [104.56, 29.77],
            '呼和浩特': [111.65, 40.82],
            '成都': [104.06, 30.67],
            '大同': [113.3, 40.12],
            '镇江': [119.44, 32.2],
            '桂林': [110.28, 25.29],
            '张家界': [110.479191, 29.117096],
            '宜兴': [119.82, 31.36],
            '北海': [109.12, 21.49],
            '西安': [108.95, 34.27],
            '金坛': [119.56, 31.74],
            '东营': [118.49, 37.46],
            '牡丹江': [129.58, 44.6],
            '遵义': [106.9, 27.7],
            '绍兴': [120.58, 30.01],
            '扬州': [119.42, 32.39],
            '常州': [119.95, 31.79],
            '潍坊': [119.1, 36.62],
            '重庆': [106.54, 29.59],
            '台州': [121.420757, 28.656386],
            '南京': [118.78, 32.04],
            '滨州': [118.03, 37.36],
            '贵阳': [106.71, 26.57],
            '无锡': [120.29, 31.59],
            '本溪': [123.73, 41.3],
            '克拉玛依': [84.77, 45.59],
            '渭南': [109.5, 34.52],
            '马鞍山': [118.48, 31.56],
            '宝鸡': [107.15, 34.38],
            '焦作': [113.21, 35.24],
            '句容': [119.16, 31.95],
            '北京': [116.46, 39.92],
            '徐州': [117.2, 34.26],
            '衡水': [115.72, 37.72],
            '包头': [110, 40.58],
            '绵阳': [104.73, 31.48],
            '乌鲁木齐': [87.68, 43.77],
            '枣庄': [117.57, 34.86],
            '杭州': [120.19, 30.26],
            '淄博': [118.05, 36.78],
            '鞍山': [122.85, 41.12],
            '溧阳': [119.48, 31.43],
            '库尔勒': [86.06, 41.68],
            '安阳': [114.35, 36.1],
            '开封': [114.35, 34.79],
            '济南': [117, 36.65],
            '德阳': [104.37, 31.13],
            '温州': [120.65, 28.01],
            '九江': [115.97, 29.71],
            '邯郸': [114.47, 36.6],
            '临安': [119.72, 30.23],
            '兰州': [103.73, 36.03],
            '沧州': [116.83, 38.33],
            '临沂': [118.35, 35.05],
            '南充': [106.110698, 30.837793],
            '天津': [117.2, 39.13],
            '富阳': [119.95, 30.07],
            '泰安': [117.13, 36.18],
            '诸暨': [120.23, 29.71],
            '郑州': [113.65, 34.76],
            '哈尔滨': [126.63, 45.75],
            '聊城': [115.97, 36.45],
            '芜湖': [118.38, 31.33],
            '唐山': [118.02, 39.63],
            '平顶山': [113.29, 33.75],
            '邢台': [114.48, 37.05],
            '德州': [116.29, 37.45],
            '济宁': [116.59, 35.38],
            '荆州': [112.239741, 30.335165],
            '宜昌': [111.3, 30.7],
            '义乌': [120.06, 29.32],
            '丽水': [119.92, 28.45],
            '洛阳': [112.44, 34.7],
            '秦皇岛': [119.57, 39.95],
            '株洲': [113.16, 27.83],
            '石家庄': [114.48, 38.03],
            '莱芜': [117.67, 36.19],
            '常德': [111.69, 29.05],
            '保定': [115.48, 38.85],
            '湘潭': [112.91, 27.87],
            '金华': [119.64, 29.12],
            '岳阳': [113.09, 29.37],
            '长沙': [113, 28.21],
            '衢州': [118.88, 28.97],
            '廊坊': [116.7, 39.53],
            '菏泽': [115.480656, 35.23375],
            '合肥': [117.27, 31.86],
            '武汉': [114.31, 30.52],
            '大庆': [125.03, 46.58]
        };
        {#        convert cityname to coordinates#}
        var convertData = function (data) {
            var res = [];
            for (var i = 0; i < data.length; i++) {
                var geoCoord = geoCoordMap[data[i].name];
                if (geoCoord) {
                    res.push({
                        name: data[i].name,
                        value: geoCoord.concat(data[i].value)
                    });
                }
            }
            return res;
        };
        {#map plot position city distribution#}
        function cityDist(data) {
            var valueDist = new Array();
            for (var i = 0; i < data['cityrec'].length; i++) {
                valueDist.push({
                    name: data['cityrec'][i][0].substr(0, data['cityrec'][i][0].length - 1),
                    value: data['cityrec'][i][1]
                })
            }
            ;

            console.log(valueDist);
            var myChart = echarts.init(document.getElementById('cityDist'));
            var option = {
                backgroundColor: '#404a59',
                title: {
                    text: '当前关注地区分布',
                    subtext: 'data by 魔法金融',
                    left: 'center',
                    textStyle: {
                        color: '#fff'
                    }
                },
                tooltip: {
                    trigger: 'item'
                },
                legend: {
                    orient: 'vertical',
                    y: 'bottom',
                    x: 'right',
                    data: ['城市数'],
                    textStyle: {
                        color: '#fff'
                    }
                },
                geo: {
                    map: 'china',
                    label: {
                        emphasis: {
                            show: false
                        }
                    },
                    roam: true,
                    itemStyle: {
                        normal: {
                            areaColor: '#323c48',
                            borderColor: '#111'
                        },
                        emphasis: {
                            areaColor: '#2a333d'
                        }
                    }
                },
                series: [
                    {
                        name: '城市数',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: convertData(valueDist),
                        symbolSize: function (val) {
                            return 5 * val[2];
                        },
                        label: {
                            normal: {
                                formatter: '{b}',
                                position: 'right',
                                show: false
                            },
                            emphasis: {
                                show: true
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: '#ddb926'
                            }
                        }
                    },
                    {
                        name: 'Top 2',
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        data: convertData(valueDist.sort(function (a, b) {
                            return b.value - a.value;
                        }).slice(0, 2)),
                        symbolSize: function (val) {
                            return 5 * val[2];
                        },
                        showEffectOn: 'render',
                        rippleEffect: {
                            brushType: 'stroke'
                        },
                        hoverAnimation: true,
                        label: {
                            normal: {
                                formatter: '{b}',
                                position: 'right',
                                show: true
                            }
                        },
                        itemStyle: {
                            normal: {
                                color: '#f4e925',
                                shadowBlur: 10,
                                shadowColor: '#333'
                            }
                        },
                        zlevel: 1
                    }
                ]
            };
            myChart.setOption(option);
        }
        {#        fzj#}
        var invest_results = {};
        var finance_results = {};
        dataSeries = {};
        var Chosenindexes = ['tot_oper_cost',
            'tot_oper_rev',
            'wgsd_net_inc',
            'tot_assets',
            'wgsd_com_eq',
            'net_inc_eq_rate',
            'total_shares',
            'earnings_per_share',
            'net_assets_per_share',
            'cash_per_share',
            'div_cashandstock',
            'payment_proportion',
            'equal_earning_rate',
            'equal_market_rate',
            'com_value_evaluate',
            'per_com_value_evaluate',
            'fre_cash_evaluate',
            'ev',
            'earning_rate',
            'net_rate',
            'sale_rate',
            'cash_rate',
            'dividendyield2',
            'cash_yield_evaluate',
            'ev1',
            'ev2',
            'employee']
        var dict1 = {

            'tot_oper_rev': '总营业收入',
            'tot_oper_cost': '总营业成本',
            'wgsd_net_inc': '净利润（股东）',
            'tot_assets': '资产总计',
            'wgsd_com_eq': '归属股东权益',
            'net_inc_eq_rate': '净资产收益率（股东）',
            'total_shares': '股本',
            'earnings_per_share': '每股收益',
            'net_assets_per_share': '每股净资产',
            'cash_per_share': '每股账面现金',
            'div_cashandstock': '每股现金股息',
            'payment_proportion': '支付比例',
            'equal_earning_rate': '均衡市盈率',
            'equal_market_rate': '均衡市净率',
            'com_value_evaluate': '公司价值估计',
            'per_com_value_evaluate': '每股价值估计',
            'fre_cash_evaluate': '自由现金流估计',
            'ev': '市值',
            'earning_rate': '市盈率',
            'net_rate': '市净率',
            'sale_rate': '市销率',
            'cash_rate': '市现率',
            'dividendyield2': '股息收益率',
            'cash_yield_evaluate': '现金收益率估计',
            'ev1': '整体价值估计（含货币）',
            'ev2': '整体价值估计（不含货币）',
            'employee': '雇员数量'
        };

        function getdata(codelist, year) {


            $.ajax({
                type: 'GET',
                url: '{{url_for("restfulapi.finance_data_new")}}',
                data: {
                    stockcode: codelist,
                    starttime: year + '1231',
                    endtime: year + '1231',
                    indexes: ['tot_oper_cost', 'tot_oper_rev', 'wgsd_net_inc', 'tot_assets', 'wgsd_com_eq', 'monetary_cap', 'operatecashflow_ttm2', 'investcashflow_ttm2']
                },
                dataType: 'json',//希望服务器返回json格式的数据
                async: false,
                success: function (data) {
                    finance_results = data;


                    {#                                                console.log(finance_results)#}
                    {#                                                finance_results_t = data;#}
                    $.ajax({
                        type: 'GET',
                        url: '{{url_for("restfulapi.invest_data_new")}}',
                        data: {
                            stockcode: codelist,
                            starttime: year + '1231',
                            endtime: year + '1231',
                            indexes: ['total_shares', 'div_cashandstock', 'ev', 'employee', 'dividendyield2', 'ev1', 'ev2']
                        },
                        async: false,
                        dataType: 'json',//希望服务器返回json格式的数据
                        success: function (data) {
                            {#                                console.log(data)#}

                            invest_results = data;
                            var index = new Array
                            for (var i = 0; i < finance_results.indexes.length; i++) {
                                if (Chosenindexes.indexOf(finance_results.indexes[i])) {
                                    dataSeries[finance_results.indexes[i]] = eval("finance_results." + finance_results.indexes[i])
                                    index.push(finance_results.indexes[i])
                                }
                            }
                            for (var i = 0; i < invest_results.indexes.length; i++) {
                                if (Chosenindexes.indexOf(invest_results.indexes[i])) {
                                    dataSeries[invest_results.indexes[i]] = eval("invest_results." + invest_results.indexes[i])
                                    index.push(invest_results.indexes[i])
                                }
                            }
                            if (Chosenindexes.indexOf("net_inc_eq_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["net_inc_eq_rate"] = tempdata
                                index.push("net_inc_eq_rate")
                            }
                            if (Chosenindexes.indexOf("earnings_per_share")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.wgsd_net_inc[i] / invest_results.total_shares[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["earnings_per_share"] = tempdata
                                index.push("earnings_per_share")
                            }
                            if (Chosenindexes.indexOf("net_assets_per_share")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.wgsd_com_eq[i] / invest_results.total_shares[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["net_assets_per_share"] = tempdata
                                index.push("net_assets_per_share")
                            }
                            if (Chosenindexes.indexOf("cash_per_share")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.monetary_cap[i] / invest_results.total_shares[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["cash_per_share"] = tempdata
                                index.push("cash_per_share")
                            }
                            if (Chosenindexes.indexOf("payment_proportion")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = (invest_results.total_shares[i] * invest_results.div_cashandstock[i]) / finance_results.wgsd_net_inc[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["payment_proportion"] = tempdata
                                index.push("payment_proportion")
                            }
                            if (Chosenindexes.indexOf("equal_earning_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = 1 / (Math.pow(1 - finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i], 5)) / (finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i])
                                    tempdata.push(datavalue)
                                }
                                dataSeries["equal_earning_rate"] = tempdata
                                index.push("equal_earning_rate")
                            }
                            if (Chosenindexes.indexOf("equal_market_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = 1 / ( Math.pow(1 - finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i], 5))
                                    tempdata.push(datavalue)
                                }
                                dataSeries["equal_market_rate"] = tempdata
                                index.push("equal_market_rate")
                            }
                            if (Chosenindexes.indexOf("com_value_evaluate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.wgsd_net_inc[i] *
                                            (1 / (Math.pow(1 - finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i], 5)) / (finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i]))
                                    tempdata.push(datavalue)
                                }
                                dataSeries["com_value_evaluate"] = tempdata
                                index.push("com_value_evaluate")
                            }
                            if (Chosenindexes.indexOf("per_com_value_evaluate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = (finance_results.wgsd_net_inc[i] *
                                            (1 / (Math.pow(1 - finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i], 5)) / (finance_results.wgsd_net_inc[i] / finance_results.wgsd_com_eq[i]))) / invest_results.total_shares[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["per_com_value_evaluate"] = tempdata
                                index.push("per_com_value_evaluate")
                            }
                            if (Chosenindexes.indexOf("fre_cash_evaluate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = finance_results.operatecashflow_ttm2[i] + finance_results.investcashflow_ttm2[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["fre_cash_evaluate"] = tempdata
                                index.push("fre_cash_evaluate")
                            }
                            if (Chosenindexes.indexOf("earning_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = invest_results.ev[i] / finance_results.wgsd_net_inc[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["earning_rate"] = tempdata
                                index.push("earning_rate")
                            }
                            if (Chosenindexes.indexOf("net_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = invest_results.ev[i] / finance_results.wgsd_com_eq[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["net_rate"] = tempdata
                                index.push("net_rate")
                            }
                            if (Chosenindexes.indexOf("sale_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = invest_results.ev[i] / finance_results.tot_oper_rev[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["sale_rate"] = tempdata
                                index.push("sale_rate")
                            }
                            if (Chosenindexes.indexOf("cash_rate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = invest_results.ev[i] / finance_results.operatecashflow_ttm2[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["cash_rate"] = tempdata
                                index.push("cash_rate")
                            }
                            if (Chosenindexes.indexOf("cash_yield_evaluate")) {
                                tempdata = []
                                for (i = 0; i < finance_results.the_name.length; i++) {
                                    datavalue = (finance_results.operatecashflow_ttm2[i] + finance_results.investcashflow_ttm2[i]) / invest_results.ev[i]
                                    tempdata.push(datavalue)
                                }
                                dataSeries["cash_yield_evaluate"] = tempdata
                                index.push("cash_yield_evaluate")
                            }
                            dataSeries['indexes'] = index
                        }
                    })
                }
            })


        }

        function CreateChart(index, unit) {
            console.log(finance_results)
            {#                console.log(dataSeries)#}
            var myChart3 = echarts.init(document.getElementById('index_chart_by_year_2'))
            var legenddata1 = [];
            var seriesdata1 = [];
            var option

            for (i = 0; i < finance_results.the_name.length; i++) {
                legenddata1.push(finance_results.the_name[i])
            }
            for (i = 0; i < finance_results.the_name.length; i++) {

                str = "dataSeries." + index
                value = eval(str)

                value2 = (value[i] / unit).toFixed(2)
                result = {value: value2, name: finance_results.the_name[i]}

                {#                    }#}
                seriesdata1.push(result)
                {#                    }#}
            }

            option = {
                title: {
                    text: '投资指标',
                    x: 'center',
                    y: 'bottom',
                    textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                        fontSize: 3,

                        fontWeight: 'lighter',
                    },
                },
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                },
                legend: {
                    orient: 'vertical',
                    x: 'left',
                    data: legenddata1,
                    fontSize: 10,
                    type: 'scroll',
                    width: 220,
                    bottom: 0,
                },
                series: [
                    {
                        name: dict1[index],
                        type: 'pie',
                        radius: ['50%', '70%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: false,
                        label: {
                            normal: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                show: true,
                                textStyle: {
                                    fontSize: '10',
                                    fontWeight: 'bold'
                                }
                            }
                        },
                        labelLine: {
                            normal: {
                                show: false
                            }
                        },
                        data: seriesdata1
                    }
                ]
            }
            myChart3.setOption(option, true);
        }
        {#            股票补全#}
        {#            var stocksuggest = $("input[name='stockcode']").bsSuggest({#}
        {#                indexKey: 1,#}
        {#                allowNoKeyword: false,#}
        {#                getDataMethod: "url",#}
        {#                url: '{{url_for("restfulapi.stock_code",q="")}}',#}
        {#                processData: function (json) {     // url 获取数据时，对数据的处理，作为 getData 的回调函数#}
        {#                    var i, len, data = {value: []};#}
        {##}
        {#                    if (!json || !json.stockcode || json.stockcode.length == 0) {#}
        {#                        return false;#}
        {#                    }#}
        {#                    len = json.stockcode.length;#}
        {##}
        {#                    for (i = 0; i < len; i++) {#}
        {#                        data.value.push({#}
        {#                            "Id": (i + 1),#}
        {#                            "stockcode": json.stockcode[i],#}
        {#                            "stockname": json.stockname[i],#}
        {#                        });#}
        {#                    }#}
        {#                    return data;#}
        {#                }#}
        {#            })#}
        {#yc#}
        var code_list = new Array();

        var name_list = new Array();

        var color = new Array();

        var order = ''
        var myChart1 = echarts.init(document.getElementById('echart1'));
        var selectedindex = new Array()
        var Uint = 1

        var indexdictionary = {
            '营业总收入': 'tot_oper_rev',
            '营业总成本': 'tot_oper_cost',
            '息税前利润率': 'ebit_rate',
            '财务费用': 'fin_exp_is',
            '利润总额': 'tot_profit',
            '净利润（总额）': 'net_profit_is',
            '净利润（股东）': 'wgsd_net_inc',
            '资产总计': 'tot_assets',
            '流动资产合计': 'tot_cur_assets',
            '非流动资产合计': 'tot_non_cur_assets',
            '负债合计': 'tot_liab',
            '流动负债合计': 'tot_cur_liab',
            '非流动负债合计': 'tot_non_cur_liab',
            '归属母公司股东权益': 'wgsd_com_eq',
            '经营活动现金净流量': 'operatecashflow_ttm2',
            '投资活动现金净流量': 'investcashflow_ttm2',
            '筹资活动现金净流量': 'financecashflow_ttm2',
            '现金净流量(TTM)': 'cashflow_ttm2',
            '货币资金': 'monetary_cap',
            '销售毛利率': 'grossprofitmargin',
            '投入资本回报率': 'roic',
            '营业周期': 'turndays',
            '存货周转天数': 'invturndays',
            '应收账款周转天数': 'arturndays',
            '应付账款周转天数': 'apturndays'
        }

        function get_selected(selected_cn) {
            if (selected_cn == '营业总收入')
                return 'tot_oper_rev'
            else if (selected_cn == '营业总成本')
                return 'tot_oper_cost'
            else if (selected_cn == '息税前利润率')
                return 'ebit_rate'
            else if (selected_cn == '财务费用')
                return 'fin_exp_is'
            else if (selected_cn == '利润总额')
                return 'tot_profit'
            else if (selected_cn == '净利润（总额）')
                return 'net_profit_is'
            else if (selected_cn == '净利润（股东）')
                return 'wgsd_net_inc'
            else if (selected_cn == '资产总计')
                return 'tot_assets'
            else if (selected_cn == '流动资产合计')
                return 'tot_cur_assets'
            else if (selected_cn == '非流动资产合计')
                return 'tot_non_cur_assets'
            else if (selected_cn == '负债合计')
                return 'tot_liab'
            else if (selected_cn == '流动负债合计')
                return 'tot_cur_liab'
            else if (selected_cn == '非流动负债合计')
                return 'tot_non_cur_liab'
            else if (selected_cn == '归属母公司股东权益')
                return 'wgsd_com_eq'
            else if (selected_cn == '经营活动现金净流量')
                return 'operatecashflow_ttm2'
            else if (selected_cn == '投资活动现金净流量')
                return 'investcashflow_ttm2'
            else if (selected_cn == '筹资活动现金净流量')
                return 'financecashflow_ttm2'
            else if (selected_cn == '现金净流量(TTM)')
                return 'cashflow_ttm2'
            else if (selected_cn == '货币资金')
                return 'monetary_cap'
            else if (selected_cn == '销售毛利率')
                return 'grossprofitmargin'
            else if (selected_cn == '投入资本回报率')
                return 'roic'
            else if (selected_cn == '营业周期')
                return 'turndays'
            else if (selected_cn == '存货周转天数')
                return 'invturndays'
            else if (selected_cn == '应收账款周转天数')
                return 'arturndays'
            else if (selected_cn == '应付账款周转天数')
                return 'apturndays'
        }

        function post_selected(selected_cn) {
            if (selected_cn == 'tot_oper_rev')
                return '营业总收入'
            else if (selected_cn == 'tot_oper_cost')
                return '营业总成本'
            else if (selected_cn == 'fin_exp_is')
                return '财务费用'
            else if (selected_cn == 'ebit_rate')
                return '息税前利润率'
            else if (selected_cn == 'tot_profit')
                return '利润总额'
            else if (selected_cn == 'net_profit_is')
                return '净利润（总额）'
            else if (selected_cn == 'wgsd_net_inc')
                return '净利润（股东）'
            else if (selected_cn == 'tot_assets')
                return '资产总计'
            else if (selected_cn == 'tot_cur_assets')
                return '流动资产合计'
            else if (selected_cn == 'tot_non_cur_assets')
                return '非流动资产合计'
            else if (selected_cn == 'tot_liab')
                return '负债合计'
            else if (selected_cn == 'tot_cur_liab')
                return '流动负债合计'
            else if (selected_cn == 'tot_non_cur_liab')
                return '非流动负债合计'
            else if (selected_cn == 'wgsd_com_eq')
                return '归属母公司股东权益'
            else if (selected_cn == 'operatecashflow_ttm2')
                return '经营活动现金净流量'
            else if (selected_cn == 'investcashflow_ttm2')
                return '投资活动现金净流量'
            else if (selected_cn == 'financecashflow_ttm2')
                return '筹资活动现金净流量'
            else if (selected_cn == 'cashflow_ttm2')
                return '现金净流量(TTM)'
            else if (selected_cn == 'monetary_cap')
                return '货币资金'
            else if (selected_cn == 'grossprofitmargin')
                return '销售毛利率'
            else if (selected_cn == 'roic')
                return '投入资本回报率'
            else if (selected_cn == 'turndays')
                return '营业周期'
            else if (selected_cn == 'invturndays')
                return '存货周转天数'
            else if (selected_cn == 'arturndays')
                return '应收账款周转天数'
            else if (selected_cn == 'apturndays')
                return '应付账款周转天数'
        }

        function getunitname(uint) {
            if (uint / 10000000 == 1) {
                return '千万'
            }
            else if (uint / 10000000 == 10) {
                return '亿'
            }
            else if (uint / 10000000 == 100) {
                return '十亿'
            }
            else if (uint / 1 == 1) {
                return '元'
            }
        }

        function set_timepicker(start, end) {
            document.getElementById('ui3').value = start
            document.getElementById('ui4').value = end
            document.getElementById('year_pie').value = end
        }


        {#        对比指标生成&&关注股票列表生成#}
        function creat_select_option() {
            for (var key in indexdictionary) {

                $("#index_select_pie").append("<option  value='" + indexdictionary[key] + "' id='" + indexdictionary[key] + "'>" + key + "</option>")

                $("#index_select").append("<option  value='" + indexdictionary[key] + "' id='" + indexdictionary[key] + "'>" + key + "</option>")
            }
            {#                for (i = 0; i < code_list.length; i++) {#}
            {#                    $("#code_show").append(#}
            {#                            "<div style='width:100%;height:30px;margin-top:10px;background-color:lightgray' class='divcheckbox'>" +#}
            {#                            "<div class='checkbox' style='width:80%;height:20px;float:left;margin-left:25px'>" +#}
            {#                            "<input type='checkbox' class='checkbox' value='" + name_list[i] + "' id='" + code_list[i] + "' >" + name_list[i] +#}
            {#                            "<div id='div_" + code_list[i] + "' style='height: 10px;width: 10px;float: right;margin: 5px'></div> " +#}
            {#                            "</div>" +#}
            {#                            "</div>")#}
            {#                }#}
            for (var key in dict1) {

                $("#index_select_pie_2").append("<option  value='" + key + "' id='" + key + "'>" + dict1[key] + "</option>")


            }
        }

        function set_color() {
            return (function (m, s, c) {
                return (c ? arguments.callee(m, s, c - 1) : '#') +
                        s[m.floor(m.random() * 16)]
            })(Math, '0123456789abcdef', 5)
        }

        function set_checked_code_color(checked_code_list, color) {
            for (var key in color) {
                $("#div_" + key).css("background-color", 'transparent')
            }
            for (i = 0; i <= checked_code_list.length; i++) {
                $("#div_" + checked_code_list[i]).css("background-color", color[checked_code_list[i]])
                {#                var checked = document.getElementById(checked_code_list[i]);//获取div下的input#}
                {#                checked.checked = true#}
            }
        }
        {#关注股票列表生成$$绘制行业分布图$$地图#}
        function creat_code_table() {
            $.ajax({
                type: 'POST',
                url: '{{url_for("restfulapi.search")}}',
                data: {
                    'code': '000001',
                },
                dataType: 'json',
                async: false,
                success: function (data) {
                    console.log(data)
                    code_list = data.code_list
                    name_list = data.name_list
                    for (i = 0; i < data.code_list.length; i++) {
                        color[data.code_list[i]] = set_color()
                        str = "<tr ><td><input type='checkbox' class='code_table' value='" + data.name_list[i] + "' id='" + data.code_list[i] + "' ></td><td>" + data.code_list[i] + "</td>" +
                                "<td>" + data.name_list[i] + "</td>" +
                                "<td>暂无</td>" +
                                "<td >暂无 </td>" +
                                "<td>" + data.count_list[i] + " </td></tr>"
                        $("#tbody").append(str)
                        $("#div_compare").append("<div style='width:100%;height:30px;margin-top:10px;' class='divcheckbox'>" +
                                "<div style='width:100%;height:20px;float:left;'>" +
                                "<input type='checkbox' class='checkbox' value='" + data.name_list[i] + "' id='" + data.code_list[i] + "' style='margin:5px'>" + data.name_list[i] +
                                " <div id='div_" + data.code_list[i] + "' style='height: 10px;width: 10px;float: right;margin: 8px'></div> </div></div>")
                    }

                    set_checked_code_color(code_list, color)
                    var table = $('#mytable1').DataTable({
                        "lengthChange": false,
                        "pageLength": 5,

                        {#                                                    "processing":false,#}
                        {#                        "scrollX": true,#}
                        "searching": false,
                        {#                        "fixedColumns": { //固定列的配置项#}
                        {#                            "leftColumns": 1//固定左边第一列#}
                        {#                        },#}
                        "language": {
                            "emptyTable": "没有数据",
                            "loadingRecords": "加载中…",
                            "processing": "查询中…",
                            "search": "检索:",
                            "lengthMenu": "每页 _MENU_ 条",
                            "zeroRecords": "没有数据",
                            "paginate": {
                                "first": "第一页",
                                "last": "最后一页",
                                "next": "",
                                "previous": ""
                            },
                            "info": "第 _PAGE_ 页 / 总 _PAGES_ 页",
                            "infoEmpty": "没有数据",
                            "infoFiltered": "(过滤总件数 _MAX_ 条)"
                        },

                    })
                    {#                    绘制地图#}
                    cityDist(data)
                    {#                        绘制行业分布图#}
                    var windpie_4 = echarts.init(document.getElementById('windpie_4'));
                    var legenddata4 = [];
                    var seriesdata4 = [];
                    var option4
                    for (var i in data.wind_4) {
                        legenddata4.push(i)
                    }
                    for (var i in data.wind_4) {
                        result = {value: data.wind_4[i], name: i}
                        seriesdata4.push(result)
                    }
                    option4 = {
                        title: {
                            text: '子行业分类',
                            x: 'center',
                            y: 'bottom',
                            textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                                fontSize: 3,

                                fontWeight: 'lighter',
                            },
                        },

                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        {#                            legend: {#}
                        {#                                orient: 'vertical',#}
                        {#                                x: 'left',#}
                        {#                                data: legenddata4,#}
                        {#                                fontSize: 10,#}
                        {#                                type: 'scroll',#}
                        {#                                width: 220,#}
                        {#                                bottom: 0,#}
                        {#                            },#}
                        series: [
                            {
                                name: '子行业',
                                type: 'pie',
                                radius: ['50%', '70%'],
                                center: ['50%', '50%'],
                                avoidLabelOverlap: false,
                                label: {
                                    normal: {
                                        show: false,
                                        position: 'center'
                                    },
                                    emphasis: {
                                        show: true,
                                        textStyle: {
                                            fontSize: '10',
                                            fontWeight: 'bold'
                                        }
                                    }
                                },
                                labelLine: {
                                    normal: {
                                        show: false
                                    }
                                },
                                data: seriesdata4
                            }
                        ]
                    }
                    windpie_4.setOption(option4, true)

                    var windpie_3 = echarts.init(document.getElementById('windpie_3'));
                    var legenddata3 = [];
                    var seriesdata3 = [];
                    var option3
                    for (var i in data.wind_3) {
                        legenddata3.push(i)
                    }
                    for (var i in data.wind_3) {
                        result = {value: data.wind_3[i], name: i}
                        seriesdata3.push(result)
                    }
                    option3 = {
                        title: {
                            text: '行业分类',
                            x: 'center',
                            y: 'bottom',
                            textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                                fontSize: 3,

                                fontWeight: 'lighter',
                            },
                        },

                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        {#                            legend: {#}
                        {#                                orient: 'vertical',#}
                        {#                                x: 'left',#}
                        {#                                data: legenddata4,#}
                        {#                                fontSize: 10,#}
                        {#                                type: 'scroll',#}
                        {#                                width: 220,#}
                        {#                                bottom: 0,#}
                        {#                            },#}
                        series: [
                            {
                                name: '行业',
                                type: 'pie',
                                radius: ['50%', '70%'],
                                center: ['50%', '50%'],
                                avoidLabelOverlap: false,
                                label: {
                                    normal: {
                                        show: false,
                                        position: 'center'
                                    },
                                    emphasis: {
                                        show: true,
                                        textStyle: {
                                            fontSize: '10',
                                            fontWeight: 'bold'
                                        }
                                    }
                                },
                                labelLine: {
                                    normal: {
                                        show: false
                                    }
                                },
                                data: seriesdata3
                            }
                        ]
                    }
                    windpie_3.setOption(option3, true)

                    var windpie_2 = echarts.init(document.getElementById('windpie_2'));
                    var legenddata2 = [];
                    var seriesdata2 = [];
                    var option2
                    for (var i in data.wind_2) {
                        legenddata2.push(i)
                    }
                    for (var i in data.wind_2) {
                        result = {value: data.wind_2[i], name: i}
                        seriesdata2.push(result)
                    }
                    option2 = {
                        title: {
                            text: '行业组',
                            x: 'center',
                            y: 'bottom',
                            textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                                fontSize: 3,

                                fontWeight: 'lighter',
                            },
                        },

                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        {#                            legend: {#}
                        {#                                orient: 'vertical',#}
                        {#                                x: 'left',#}
                        {#                                data: legenddata4,#}
                        {#                                fontSize: 10,#}
                        {#                                type: 'scroll',#}
                        {#                                width: 220,#}
                        {#                                bottom: 0,#}
                        {#                            },#}
                        series: [
                            {
                                name: '行业组',
                                type: 'pie',
                                radius: ['50%', '70%'],
                                center: ['50%', '50%'],
                                avoidLabelOverlap: false,
                                label: {
                                    normal: {
                                        show: false,
                                        position: 'center'
                                    },
                                    emphasis: {
                                        show: true,
                                        textStyle: {
                                            fontSize: '10',
                                            fontWeight: 'bold'
                                        }
                                    }
                                },
                                labelLine: {
                                    normal: {
                                        show: false
                                    }
                                },
                                data: seriesdata2
                            }
                        ]
                    }
                    windpie_2.setOption(option2, true)

                    var windpie_1 = echarts.init(document.getElementById('windpie_1'));
                    var legenddata1 = [];
                    var seriesdata1 = [];
                    var option1
                    for (var i in data.wind_1) {
                        legenddata1.push(i)
                    }
                    for (var i in data.wind_1) {
                        result = {value: data.wind_1[i], name: i}
                        seriesdata1.push(result)
                    }
                    option1 = {
                        title: {
                            text: '部门',
                            x: 'center',
                            y: 'bottom',
                            textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                                fontSize: 3,

                                fontWeight: 'lighter',
                            },
                        },

                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br/>{b}: {c} ({d}%)"
                        },
                        {#                            legend: {#}
                        {#                                orient: 'vertical',#}
                        {#                                x: 'left',#}
                        {#                                data: legenddata4,#}
                        {#                                fontSize: 10,#}
                        {#                                type: 'scroll',#}
                        {#                                width: 220,#}
                        {#                                bottom: 0,#}
                        {#                            },#}
                        series: [
                            {
                                name: '部门',
                                type: 'pie',
                                radius: ['50%', '70%'],
                                center: ['50%', '50%'],
                                avoidLabelOverlap: false,
                                label: {
                                    normal: {
                                        show: false,
                                        position: 'center'
                                    },
                                    emphasis: {
                                        show: true,
                                        textStyle: {
                                            fontSize: '10',
                                            fontWeight: 'bold'
                                        }
                                    }
                                },
                                labelLine: {
                                    normal: {
                                        show: false
                                    }
                                },
                                data: seriesdata1
                            }
                        ]
                    }
                    windpie_1.setOption(option1, true)
                }
            })
        }
        {#对比表#}
        function creattable(stock_code_list, unit, start, end) {
            $("#table_head").empty();
            $("#table_body").empty();
            head = "<th  >对比数据(单位:" + getunitname(unit) + ")</th>"
            for (i = end; i >= start; i--) {
                head += "<th >" + i + "</th>"
            }
            $("#table_head").append("<tr >" + head + "</tr>")
            $('#fixTable').DataTable({
                "info": false,
                "processing": true,
                "searching": true,
                "language": {
                    "emptyTable": "没有数据",
                    "loadingRecords": "加载中…",
                    "processing": "查询中…",
                    "search": "检索:",
                    "lengthMenu": "每页 _MENU_ 条",
                    "zeroRecords": "没有数据",
                    "paginate": {
                        "first": "第一页",
                        "last": "最后一页",
                        "next": "",
                        "previous": ""
                    },
                    "info": "第 _PAGE_ 页 / 总 _PAGES_ 页",
                    "infoEmpty": "没有数据",
                    "infoFiltered": "(过滤总件数 _MAX_ 条)"
                }
            })
            for (j = 0; j < stock_code_list.length; j++) {
                code = stock_code_list[j]
                $.ajax({
                    type: 'POST',
                    url: '{{url_for("restfulapi.get_ajax_compare")}}',
                    data: {
                        'code': code,
                        'date': [start, end],
                        'index': selectedindex
                    },
                    dataType: 'json',
                    success: function (data) {
                        Data = ''
                        Data = data
                        for (i = 0; i < data.indexs.length; i++) {
                            str1 = "color['" + data.the_code + "']"
                            line = "<td style='color:" + eval(str1) + "'>" + data.the_name + "</td>"
                            str = "data." + data.indexs[i]
                            results = eval(str)
                            for (k = 0; k < results.length; k++) {
                                line += "<td >" + (results[k] / unit).toFixed(2) + "</td>"
                            }
                            $("#table_body").append("<tr>" + line + "</tr>")
                        }
                    }
                });
            }

        }

        function RequestTable() {
            var myChart = echarts.init(document.getElementById('echart1'));
            var opt = myChart.getOption();
            var dz = opt.dataZoom[0];
            if (order == 'desc') {
                creattable(code_list, Uint, opt.xAxis[0].data[dz.endValue], opt.xAxis[0].data[dz.startValue])
            }
            else if (order == 'asc') {
                creattable(code_list, Uint, opt.xAxis[0].data[dz.startValue], opt.xAxis[0].data[dz.endValue])
            }

        }

        function addStock() {

            $.ajax({
                type: 'POST',
                url: '{{url_for("restfulapi.iscode")}}',
                data: {
                    'code': $("#stockcode").val(),
                },
                dataType: 'json',
                success: function (data) {
                    if (data.the_name != 'false') {
                        $.ajax({
                            type: 'POST',
                            url: '{{url_for("restfulapi.is_repeatcode")}}',
                            data: {
                                'code': $("#stockcode").val(),
                            },
                            dataType: 'json',
                            success: function (data) {
                                if (data.exit == 'true') {
                                    alert('您已关注该股票，请勿重复操作！')
                                }
                                else if (data.exit == 'flase') {
                                    $.ajax({
                                        type: 'POST',
                                        url: '{{url_for("restfulapi.add_code_fd_yc")}}',
                                        data: {
                                            'code': $("#stockcode").val(),
                                        },
                                        dataType: 'json',
                                        success: function (data) {
                                            location.reload()
                                            {#                                                first_visit()#}
                                        }
                                    })
                                }
                            }
                        })
                    }
                    else {
                        alert($("#stockcode").val() + "号股票不存在！")
                    }
                }
            })

        }

        $("#deleteStock").click(function () {
            var delete_list = new Array()
            $('.code_table').each(function () {
                if ($(this).is(':checked')) {
                    delete_list.push($(this).attr('id'))
                }
            })
            console.log(delete_list)
            $.ajax({
                type: 'POST',
                url: '{{url_for("restfulapi.delete_code")}}',
                data: {
                    'selected': delete_list
                },
                dataType: 'json',
                success: function (data) {
                    alert('删除成功')
                    location.reload()
                }
            })
        })

        $(document).ready(function () {

            function createchart(stock_code_list, unit, dzstart, dend) {
                var legenddata1 = new Array();
                var seriesdata1 = [];
                var result = {};
                var aAxisdata1 = new Array();
                for (k = 0; k < stock_code_list.length; k++) {
                    $.ajax({
                        type: 'POST',
                        url: '{{url_for("restfulapi.get_ajax_compare")}}',
                        data: {
                            'code': stock_code_list[k],
                            'date': ['1991', '2016'],
                            'index': selectedindex
                        },
                        dataType: 'json',
                        success: function (data) {
                            if (order == 'desc') {
                                for (i = 0; i < data.indexs.length; i++) {
                                    legenddata1.push(data.the_name)
                                    index_title = post_selected(data.indexs[i])
                                }
                                aAxisdata1 = data.the_year_list
                                for (i = 0; i < data.indexs.length; i++) {
                                    str = "data." + data.indexs[i]
                                    value = eval(str)
                                    var value2 = [];
                                    for (var j = 0; j < value.length; j++) {
                                        value2.push((value[j] / unit).toFixed(2))
                                    }
                                    result = {
                                        name: data.the_name,
                                        type: 'line',
                                        smooth: true,
                                        itemStyle: {
                                            normal: {
                                                color: color[data.the_code],
                                                lineStyle: {
                                                    color: color[data.the_code]
                                                },
                                            }
                                        },
                                        symbolSize: 8,
                                        data: value2
                                    }
                                    seriesdata1.push(result)
                                }

                                option = {
                                    title: {
                                        text: "对比数据:" + index_title + "（单位：" + getunitname(unit) + "）"
                                    },
                                    tooltip: {
                                        trigger: 'axis'
                                    },
                                    {#                                    legend: {#}
                                    {#                                        type: 'scroll',#}
                                    {#                                        orient: 'vertical',#}
                                    {#                                        left: 5,#}
                                    {#                                        top: 50,#}
                                    {#                                        width: 80,#}
                                    {#                                        bottom: 20,#}
                                    {#                                        data: legenddata1#}
                                    {#                                    },#}
                                    grid: {
{#                                        left: 100,#}
                                        right: '4%',
                                        bottom: '3%',
                                        containLabel: true
                                    },
                                    toolbox: {

                                        feature: {
                                            saveAsImage: {},
                                            magicType: {
                                                type: ['line', 'bar', 'stack', 'tiled']
                                            }
                                        }
                                    },
                                    xAxis: {
                                        type: 'category',
                                        boundaryGap: false,
                                        axisTick: {
                                            show: false
                                        },
                                        data: aAxisdata1,
                                    },
                                    yAxis: {
                                        type: 'value',
                                        axisTick: {
                                            show: false
                                        },
                                    },
                                    dataZoom: [
                                        {
                                            {#                                id: 'dataZoomX',#}
                                            type: 'slider',
                                            xAxisIndex: [0],
                                            height: 20,
                                            filterMode: 'filter',
                                            {#                                show : true,#}
                                            startValue: dzstart,
                                            endValue: dend,
                                        },

                                    ],
                                    series: seriesdata1
                                };

                            }
                            else if (order == 'asc') {
                                for (i = data.indexs.length - 1; i >= 0; i--) {
                                    legenddata1.push(data.the_name)
                                    index_title = post_selected(data.indexs[i])
                                }

                                aAxisdata1 = data.the_year_list.sort()

                                for (i = data.indexs.length - 1; i >= 0; i--) {
                                    str = "data." + data.indexs[i]
                                    value = eval(str)
                                    var value2 = [];
                                    for (var j = value.length - 1; j >= 0; j--) {
                                        value2.push((value[j] / unit).toFixed(2))
                                    }
                                    result = {
                                        name: data.the_name,
                                        {#                                        + "(" + post_selected(data.indexs[i]) + ")"#}
                                        type: 'line',
                                        smooth: true,
                                        symbolSize: 8,
                                        itemStyle: {
                                            normal: {
                                                color: color[data.the_code],
                                                lineStyle: {
                                                    color: color[data.the_code]
                                                }
                                            }
                                        },
                                        data: value2
                                    }
                                    seriesdata1.push(result)
                                }
                                option = {
                                    title: {
                                        text: "对比指标:" + index_title + "（单位：" + getunitname(unit) + "）"
                                    },
                                    tooltip: {
                                        trigger: 'axis'
                                    },
                                    {#                                    legend: {#}
                                    {#                                        type: 'scroll',#}
                                    {#                                        orient: 'vertical',#}
                                    {#                                        left: 5,#}
                                    {#                                        top: 50,#}
                                    {#                                        bottom: 20,#}
                                    {#                                        width: 80,#}
                                    {#                                        data: legenddata1#}
                                    {#                                    },#}
                                    grid: {
{#                                        left: 100,#}
                                        right: '4%',
                                        bottom: '3%',
                                        containLabel: true
                                    },
                                    toolbox: {

                                        feature: {
                                            saveAsImage: {},
                                            magicType: {
                                                type: ['line', 'bar', 'stack', 'tiled']
                                            }
                                        }
                                    },
                                    xAxis: {
                                        type: 'category',
                                        boundaryGap: false,
                                        axisTick: {
                                            show: false
                                        },
                                        data: aAxisdata1,
                                    },
                                    yAxis: {
                                        type: 'value',
                                        axisTick: {
                                            show: false
                                        },
                                    },
                                    dataZoom: [
                                        {
                                            {#                                id: 'dataZoomX',#}
                                            type: 'slider',
                                            xAxisIndex: [0],
                                            height: 20,
                                            filterMode: 'filter',
                                            {#                                show : true,#}
                                            startValue: dzstart,
                                            endValue: dend,
                                        },

                                    ],
                                    series: seriesdata1
                                };

                            }
                            myChart1.setOption(option, true);
                            myChart1.on('dataZoom', function (params) {
                                var nstartyear = 1991 + Math.ceil(params.start / 100 * 25)
                                var nendyear = 1991 + Math.ceil(params.end / 100 * 25) - 1
                                set_timepicker(nstartyear, nendyear)
                            });
                        }
                    })

                }
            }

            function index_chart_by_year(code_list, index, year, unit) {

                var myChart2 = echarts.init(document.getElementById('index_chart_by_year'));

                var legenddata1 = [];
                var seriesdata1 = [];
                var option
                for (k = 0; k < code_list.length; k++) {
                    $.ajax({
                        type: 'POST',
                        url: '{{url_for("restfulapi.get_ajax_compare")}}',
                        data: {
                            'code': code_list[k],
                            'date': [year, year],
                            'index': index
                        },
                        async: false,
                        dataType: 'json',
                        success: function (data) {
                            for (i = 0; i < data.indexs.length; i++) {
                                legenddata1.push(data.the_name)
                                {#                                index_title = post_selected(data.indexs[i])#}
                            }
                            for (i = 0; i < data.indexs.length; i++) {
                                str = "data." + data.indexs[i]
                                value = eval(str)
                                var value2 = [];
                                for (var j = 0; j < value.length; j++) {
                                    value2.push((value[j] / unit).toFixed(2))
                                }
                                result = {value: value2, name: data.the_name}
                                seriesdata1.push(result)
                            }
                            option = {
                                title: {
                                    text: '财务指标',
                                    x: 'center',
                                    y: 'bottom',
                                    textStyle: {//主标题文本样式{"fontSize": 18,"fontWeight": "bolder","color": "#333"}

                                        fontSize: 3,

                                        fontWeight: 'lighter',
                                    },
                                },

                                tooltip: {
                                    trigger: 'item',
                                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                                },
                                legend: {
                                    orient: 'vertical',
                                    x: 'left',
                                    data: legenddata1,
                                    fontSize: 10,
                                    type: 'scroll',
                                    width: 220,
                                    bottom: 0,
                                },
                                series: [
                                    {
                                        name: post_selected(data.indexs[0]),
                                        type: 'pie',
                                        radius: ['50%', '70%'],
                                        center: ['50%', '50%'],
                                        avoidLabelOverlap: false,
                                        label: {
                                            normal: {
                                                show: false,
                                                position: 'center'
                                            },
                                            emphasis: {
                                                show: true,
                                                textStyle: {
                                                    fontSize: '10',
                                                    fontWeight: 'bold'
                                                }
                                            }
                                        },
                                        labelLine: {
                                            normal: {
                                                show: false
                                            }
                                        },
                                        data: seriesdata1
                                    }
                                ]
                            }

                        }
                    })
                }
                myChart2.setOption(option, true);

            }

            function creat_code_wind(codelist) {
                {#                    console.log(codelist)#}
                $.ajax({
                    type: 'POST',
                    url: '{{url_for("restfulapi.code_wind")}}',
                    data: {
                        'codelist': codelist
                    },
                    dataType: 'json',
                    success: function (data) {
                        console.log(data)
                    }
                })
            }

            function first_visit() {
                creat_select_option()
                Uint = 100000000
                order = 'asc'
                {#                    $(".checkbox").each(function () {#}
                {#                        $("input[type='checkbox']").prop("checked","checked")#}
                {#                    })#}


                {# 首次访问，填充datatable   #}
                creat_code_table()
                {#                    $("input[type=checkbox]").each(function () {#}
                {#                        $(this).iCheck('check');#}
                {#                    })#}
                $(".checkbox").each(function () {
                    $(this).attr("checked", true)
                })
                selectedindex = ['tot_oper_rev']
                set_timepicker('2010-q4', '2015-q4')

                {#财务指标饼图#}
                index_chart_by_year(code_list, selectedindex, '2015', 1)
                {#投资指标饼图#}
                getdata(code_list, '2015')
                CreateChart(selectedindex, 1)
                {# 绘制对比图#}
                createchart(code_list, Uint, '2010', '2015')
                {#                    绘制行业分布#}
                {#                    creat_code_wind(code_list)#}
            }

            first_visit()

            $('select#index_select').change(function () {
                var unit = document.getElementById("unit").value;
                var dzstartyear = $('#ui3').val().substring(0, 4)
                var dzendyear = $('#ui4').val().substring(0, 4)
                order = document.getElementById("yearorder").value;
                Uint = unit
                selectedindex = []
                selectedindex.push(document.getElementById("index_select").value)
                createchart(code_list, Uint, dzstartyear, dzendyear)
                creattable(code_list, Uint, dzstartyear, dzendyear)
                {#                if (!$(this).is(':checked')) {// 取消 用于记录-无用#}
                {#                    var unit = document.getElementById("unit").value;#}
                {#                    var dzstartyear = $('#ui3').val().substring(0, 4)#}
                {#                    var dzendyear = $('#ui4').val().substring(0, 4)#}
                {##}
                {#                    selectedindex = []#}
                {#                    createchart(code_list, unit, dzstartyear, dzendyear)#}
                {##}
                {##}
                {#                }#}
                {#                else {#}
                {#                    var unit = document.getElementById("unit").value;#}
                {#                    var dzstartyear = $('#ui3').val().substring(0, 4)#}
                {#                    var dzendyear = $('#ui4').val().substring(0, 4)#}
                {#                    $("input[type=checkbox]").each(function () {#}
                {#                        $(this).iCheck('uncheck');#}
                {#                    })#}
                {#                    $(this).iCheck('check')#}
                {#                    selectedindex = []#}
                {#                    selectedindex.push($(this).attr('value'))#}
                {#                    Uint = unit#}
                {#                    createchart(code_list, Uint, dzstartyear, dzendyear)#}

                {#            }#}
            })
            $("#ui3").datepicker({
                changeYear: true,
                dateFormat: 'yy',
                showButtonPanel: true,
                yearRange: "1991:2016",

                onClose: function (dateText, inst) {
                    var year = $("#ui-datepicker-div .ui-datepicker-year option:selected").val();//得到选中的年份值
                    $('#ui3').val(year + '-q4');
                    var unit = document.getElementById("unit").value;
                    var dzstartyear = $('#ui3').val().substring(0, 4)
                    var dzendyear = $('#ui4').val().substring(0, 4)
                    Uint = unit
                    createchart(code_list, Uint, dzstartyear, dzendyear)
                    creattable(code_list, Uint, dzstartyear, dzendyear)
                }
            });
            $("#ui4").datepicker({
                changeYear: true,
                dateFormat: 'yy',
                showButtonPanel: true,
                yearRange: "1991:2016",
                onClose: function (dateText, inst) {
                    var year = $("#ui-datepicker-div .ui-datepicker-year option:selected").val();//得到选中的年份值
                    $('#ui4').val(year + '-q4');//给input赋值，其中要对月值加1才是实际的月份
                    var unit = document.getElementById("unit").value;
                    var dzstartyear = $('#ui3').val().substring(0, 4)
                    var dzendyear = $('#ui4').val().substring(0, 4)
                    Uint = unit
                    createchart(code_list, Uint, dzstartyear, dzendyear)
                    creattable(code_list, Uint, dzstartyear, dzendyear)
                }
            });
            $("#year_pie").datepicker({
                changeYear: true,
                dateFormat: 'yy',
                showButtonPanel: true,
                yearRange: "1991:2016",
                onClose: function (dateText, inst) {
                    index = []
                    var year_pie = $("#ui-datepicker-div .ui-datepicker-year option:selected").val();//得到选中的年份值
                    $('#year_pie').val(year_pie + '-q4');//给input赋值，其中要对月值加1才是实际的月份
                    var index_pie = document.getElementById("index_select_pie").value
                    var index_pie_2 = document.getElementById("index_select_pie_2").value
                    index.push(index_pie)
                    console.log(code_list, index_pie, year_pie)
                    {#                    index_chart_by_year(code_list, selectedindex, '2016', 1)#}
                    index_chart_by_year(code_list, index, year_pie, 1)


                    getdata(code_list, year_pie)

                    CreateChart(index_pie_2, 1)
                }
            });
            $('select#index_select_pie').change(function () {
                index = []
                var year_pie = $('#year_pie').val().substring(0, 4)
                var index_pie = document.getElementById("index_select_pie").value
                index.push(index_pie)
                console.log(year_pie)
                index_chart_by_year(code_list, index, year_pie, 1)
                {#                    getdata(code_list, year_pie)#}
                {##}
                {#                    CreateChart(index, 1)#}

            })
            $('select#index_select_pie_2').change(function () {
                index = []
                var year_pie = $('#year_pie').val().substring(0, 4)
                var index_pie = document.getElementById("index_select_pie_2").value

                getdata(code_list, year_pie)

                CreateChart(index_pie, 1)

            })
            $("select#unit").change(function () {
                var unit = document.getElementById("unit").value;
                var dzstartyear = $('#ui3').val().substring(0, 4)
                var dzendyear = $('#ui4').val().substring(0, 4)
                Uint = unit
                createchart(code_list, Uint, dzstartyear, dzendyear)
                creattable(code_list, Uint, dzstartyear, dzendyear)
            });
            $("select#yearorder").change(function () {
                var unit = document.getElementById("unit").value;
                var dzstartyear = $('#ui3').val().substring(0, 4)
                var dzendyear = $('#ui4').val().substring(0, 4)
                order = document.getElementById("yearorder").value;
                Uint = unit
                {#                option.dataZoom[0].startValue = dzstartyear#}
                {#                option.dataZoom[0].endValue = dzendyear#}
                {#                myChart1.setOption(option)#}
                createchart(code_list, Uint, dzstartyear, dzendyear)
                creattable(code_list, Uint, dzstartyear, dzendyear)
            });
            $('.checkbox').on('click', function () {
                if (!$(this).is(':checked')) {// 取消
                    {#                                var myChart = echarts.getInstanceByDom(document.getElementById("echart"))#}
                    $(this).css("background-color", 'transparent')
                    color[$(this).attr('id')] = 'transparent'
                    var selected_code = new Array()
                    var unit = document.getElementById("unit").value;
                    var dzstartyear = $('#ui3').val().substring(0, 4)
                    var dzendyear = $('#ui4').val().substring(0, 4)
                    color[$(this).attr('value')] = 'transparent'
                    $(".checkbox").each(function () {
                        if ($(this).is(':checked')) {
                            selected_code.push($(this).attr('id'))
                        }
                    })
                    console.log(selected_code)
                    set_checked_code_color(selected_code, color)

                    createchart(selected_code, Uint, dzstartyear, dzendyear)
                    creattable(selected_code, Uint, dzstartyear, dzendyear)
                }
                else {
                    {#                                var myChart = echarts.getInstanceByDom(document.getElementById("echart"))#}
                    {#                    $(this).css("background-color", 'transparent')#}
                    color[$(this).attr('id')] = set_color()
                    var selected_code = new Array()
                    var unit = document.getElementById("unit").value;
                    var dzstartyear = $('#ui3').val().substring(0, 4)
                    var dzendyear = $('#ui4').val().substring(0, 4)
                    {#                                color[$(this).attr('value')] = 'transparent'#}
                    $(".checkbox").each(function () {
                        if ($(this).is(':checked')) {
                            selected_code.push($(this).attr('id'))
                        }
                    })
                    set_checked_code_color(selected_code, color)
                    createchart(selected_code, Uint, dzstartyear, dzendyear)
                    creattable(selected_code, Uint, dzstartyear, dzendyear)


                }
            });

            $.fn.dataTable.ext.errMode = 'none';
            $("#hyfb").click(function () {
                $(".fb").hide()
                $("#div_hyfb").toggle();

            });
            $("#dqfb").click(function () {
                $(".fb").hide()
                $("#div_dqfb").toggle();
            });
            $("#sssj").click(function () {
                $(".fb").hide()
                $("#div_sssj").toggle();
            });

        })
    </script>
{% endblock %}
{% block map %}

    <div id="cityDist" style="width:100%;height:260px">

    </div>

{% endblock %}